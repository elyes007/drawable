<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>storyboard</title>
    <style type="text/css">

        #storybody {
            background-color: #585C5F;
            position: relative;
            overflow: auto;
        }

        .pageDiv {
            position: absolute;
            z-index: 1;
        }

        .dragBar {
            cursor: move;
            height: 20px;
            border: 1px solid lightgray;
            background-color: lightgray;
            margin-bottom: 4px;
            border-radius: 2px;
        }

        .dragBar:hover {
            background-color: lightgray;
        }

        .title {
            text-align: center;
            margin: 0 0 0 0;
            font-family: Helvetica;
        }

        .page {
            position: relative;
            width: 200px;
            height: 398px;
            overflow: hidden;
            background-color: white;
        }

        .arrow {
            stroke: rgb(0, 0, 0);
            stroke-width: 2;
            marker-end: url(#markerArrow)
        }

        .segue {
            stroke: rgb(0, 0, 0);
            stroke-width: 2;
        }

        #add-container {
            position: relative;
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            left: 16px;
            top: 16px;
            width: 200px;
            height: 398px;
            border-radius: 8px;
            border: 1px dashed black;
            cursor: pointer;
            opacity: 0.7;
        }

        #add-container:hover {
            opacity: 1;
        }

        #add {
            display: inline-block;
            background: #517d5e;
            height: 100px;
            position: relative;
            width: 20px;
        }

        #add:after {
            background: #517d5e;
            content: "";
            height: 20px;
            left: -40px;
            position: absolute;
            top: 40px;
            width: 100px;
        }

        .navMessage {
            position: absolute;
            display: inline-block;
            width: 200px;
            background-color: #3C3F41;
            border-radius: 16px;
            z-index: 2;
            padding-bottom: 16px;
        }

        .yesBtn {
            position: relative;
            right: -57%;
            cursor: pointer;
            background-color: transparent;
            font-family: Helvetica;
            font-weight: bold;
            color: white;
            padding: 4px 8px 4px 8px;
            border-radius: 4px;
        }

        /*
                .yesBtn:hover {
                    background-color: white;
                }*/

        .nopeBtn {
            position: relative;
            right: -57%;
            margin: 8px 4px 0 4px;
            cursor: pointer;
            background-color: transparent;
            font-family: Helvetica;
            font-weight: bold;
            color: white;
            padding: 4px 8px 4px 8px;
            border-radius: 4px;
        }

        /*
                .nopeBtn:hover {
                    background-color: white;
                }*/

    </style>
    <script src="https://unpkg.com/@ionic/core@latest/dist/ionic.js"></script>
    <link href="https://unpkg.com/@ionic/core@latest/css/ionic.bundle.css" rel="stylesheet">
</head>
<body oncontextmenu="return false;" id="storybody">

<svg height="5000px" width="5000px" style="position: absolute; z-index: 2; pointer-events: none;" id="svg">
    <defs>
        <marker id="markerArrow" markerWidth="15" markerHeight="15" refX="2" refY="6"
                orient="auto">
            <path d="M2,2 L2,11 L10,6 L2,2" style="fill: #000000;"/>
        </marker>
    </defs>
</svg>

<div id="add-container" onclick="java.addPage()">
    <div id="add"></div>
</div>

<script type="text/javascript">
    var nav = false
    shouldDismiss = false
    window.onload = function () {
        zoom = 50;
        document.body.style.zoom = zoom + "%"
        drawStoryboard();
        document.onmousedown = startDrag;
        document.onmouseup = stopDrag;
        document.onkeydown = (e) =
    >
        {
            var evtobj = window.event ? event : e
            if ((evtobj.keyCode == 107 || evtobj.keyCode == 61) && evtobj.ctrlKey) {
                zoom = Math.min(100, zoom + 10)
                document.body.style.zoom = zoom + "%"
            }
            if ((evtobj.keyCode == 109 || evtobj.keyCode == 54) && evtobj.ctrlKey) {
                zoom = Math.max(30, zoom - 10)
                document.body.style.zoom = zoom + "%"
            }
            if ((evtobj.keyCode == 96 || evtobj.keyCode == 48) && evtobj.ctrlKey) {
                zoom = 100
                document.body.style.zoom = zoom + "%"
            }
        }
    }

    function drawStoryboard() {
        fetch('storyboard.json')
            .then(response = > response.json()
    )
    .
        then(json = > {
            pages = {}
            json.forEach(function (obj) {
                obj.to = []
                obj.from = []
                pages[obj.page] = obj

                fetch('./pages/' + obj.page + '/' + obj.page + '.html')
                    .then(response = > response.text()
            )
            .
                then(text = > {
                    const html = document.createElement("html")
                    html.innerHTML = text;

                const div = document.createElement("div")
                div.style.left = obj.x + 'px'
                div.style.top = obj.y + 'px'
                div.className = 'pageDiv'
                div.id = obj.page + '-container'

                const dragBar = document.createElement("div")
                dragBar.id = obj.page + '-dragBar'
                dragBar.className = 'dragBar'

                const pageContainer = document.createElement("div")
                pageContainer.id = obj.page
                pageContainer.className = 'page'
                const ionApp = html.querySelector("ion-app")
                for (let img of ionApp.getElementsByTagName("ion-img")) {
                    img.src = img.src.substring(img.src.search('assets'), img.src.length)
                }
                pageContainer.appendChild(ionApp)
                //pageContainer.onclick = (e) => java.openPage(obj.page)

                div.appendChild(dragBar)
                div.appendChild(pageContainer)
                document.querySelector("body").appendChild(div)
            })
            })
            drawArrows()
        }
    )
    }

    async

    function drawArrows() {
        for (const key in pages) {
            if (pages.hasOwnProperty(key)) {
                const page = pages[key];
                const svg = document.getElementById("svg")

                await
                fetch('pages/' + key + '/conf.json')
                    .then(response = > response.json()
            )
            .
                then(json = > {
                    const title = document.createElement("p")
                    title.className = "title"
                    title.innerHTML = json.page
                    document.querySelector("#" + key + "-dragBar").appendChild(title)

                    json.actions.forEach(action = > {
                        if(action.type !== 'nav'
            )
                return

                page.to.push({
                    dest: action.dest,
                    button: action.button
                })
                pages[action.dest].from.push(key)
                const segue = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                segue.setAttribute('id', key + '-' + action.dest);
                segue.setAttribute("stroke", "black")
                segue.setAttribute("class", "segue")
                setSeguePosition(segue, page.page, action.dest)
                svg.appendChild(segue)
            })
                ;
            })
            }
        }

        for (const key in pages) {
            if (pages.hasOwnProperty(key)) {
                const page = pages[key];
                if (page.from.length == 0) continue

                const enterArrow = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                enterArrow.setAttribute('id', key + '-enterArrow');
                enterArrow.setAttribute("stroke", "black")
                enterArrow.setAttribute("class", "arrow")
                setEnterArrowPosition(enterArrow, key)
                svg.appendChild(enterArrow)
            }
        }
    }

    function setSeguePosition(segue, src, dest) {
        src = document.getElementById(src)
        dest = document.getElementById(dest)

        let left1 = parseInt(src.parentElement.style.left.slice(0, src.parentElement.style.left.length - 2))
        let top1 = parseInt(src.parentElement.style.top.slice(0, src.parentElement.style.top.length - 2))
        let left2 = parseInt(dest.parentElement.style.left.slice(0, dest.parentElement.style.left.length - 2))
        let top2 = parseInt(dest.parentElement.style.top.slice(0, dest.parentElement.style.top.length - 2))

        segue.setAttribute('x1', left1 + 202);
        segue.setAttribute('y1', top1 + 20 + 4 + src.clientHeight / 2);
        segue.setAttribute('x2', left2 - 60);
        segue.setAttribute('y2', top2 + 20 + 4 + dest.clientHeight / 2);
    }

    function setEnterArrowPosition(arrow, pageId) {
        let page = document.getElementById(pageId)

        let left = parseInt(page.parentElement.style.left.slice(0, page.parentElement.style.left.length - 2))
        let top = parseInt(page.parentElement.style.top.slice(0, page.parentElement.style.top.length - 2))

        arrow.setAttribute('x1', left - 60);
        arrow.setAttribute('y1', top + 20 + 4 + page.clientHeight / 2);
        arrow.setAttribute('x2', left - 16);
        arrow.setAttribute('y2', top + 20 + 4 + page.clientHeight / 2);
    }

    function startDrag(e) {
        // determine event object
        if (!e) {
            var e = window.event;
        }

        targ = e.target ? e.target : e.srcElement;

        if (shouldDismiss && targ.className != 'yesBtn' && targ.className != 'nopeBtn') {
            document.querySelector("body").removeChild(document.getElementsByClassName('navMessage')[0])
            const svg = document.getElementById("svg")
            svg.removeChild(svg.getElementById("navArrow"))
        }
        shouldDismiss = false

        if (e.button === 2) {
            if (targ.tagName.toLowerCase() != 'ion-button') return
            startNavDrag(e)
            if (e.preventDefault) e.preventDefault();
            return;
        }

        if (targ.className != 'dragBar') {
            if (targ.className == 'title') {
                targ = targ.parentElement
            } else {
                return;
            }
        }

        if (e.preventDefault) e.preventDefault();

        console.log('start drag')
        // calculate event X, Y coordinates
        offsetX = e.clientX;
        offsetY = e.clientY;

        // assign default values for topp and left properties
        if (!targ.parentElement.style.left) {
            targ.parentElement.style.left = '0px'
        }
        ;
        if (!targ.parentElement.style.top) {
            targ.parentElement.style.top = '0px'
        }
        ;

        // calculate integer values for top and left
        // properties
        coordX = parseInt(targ.parentElement.style.left);
        coordY = parseInt(targ.parentElement.style.top);
        drag = true;

        // move div element
        document.onmousemove = dragDiv;
        return false;

    }

    function dragDiv(e) {
        if (!drag) {
            return
        }
        ;
        if (!e) {
            var e = window.event
        }
        ;

        targ.parentElement.style.left = coordX + e.clientX - offsetX + 'px';
        targ.parentElement.style.top = coordY + e.clientY - offsetY + 'px';

        targ = targ.parentElement.children[1]

        const enterArrow = document.getElementById(targ.id + "-enterArrow")
        if (enterArrow) setEnterArrowPosition(enterArrow, targ.id)

        let to = pages[targ.id].to
        to.forEach(nav = > {
            const segue = document.getElementById(targ.id + "-" + nav.dest)
            setSeguePosition(segue, targ.id, nav.dest
    )
    })
        ;

        let from = pages[targ.id].from
        from.forEach(src = > {
            const segue = document.getElementById(src + "-" + targ.id)
            setSeguePosition(segue, src, targ.id
    )
    })
        ;

        return false;
    }

    function stopDrag(e) {
        drag = false;
        if (!nav) {
            java.updateStoryboard(targ.id, parseInt(targ.parentElement.style.left) + "", parseInt(targ.parentElement.style.top) + "")
            return
        }
        nav = false
        const target = targ
        let element = document.elementFromPoint(e.clientX, e.clientY)
        while (element) {
            if (element.className == 'page') {
                break
            }
            element = element.parentNode;
        }

        if (!element) {
            const svg = document.getElementById("svg")
            svg.removeChild(svg.getElementById("navArrow"))
            return
        }
        //check if button is free of actions
        let free = true
        let dest
        pages[target.id].to.forEach(nav = > {
            if(nav.button == buttonId
    )
        {
            free = false
            dest = nav.dest
        }
    })
        ;

        //if button is free add navigation
        if (free) {
            //remove temp segue
            const svg2 = document.getElementById("svg")
            svg2.removeChild(svg2.getElementById("navArrow"))
            addNavigation(target, element)
            return
        }
        //else show confirmation message to overwrite current action
        let offsetLeft = document.body.scrollLeft
        let offsetTop = document.body.scrollTop
        const navMessage = document.createElement("div")
        navMessage.className = 'navMessage'
        navMessage.style.left = e.clientX + offsetLeft + 'px'
        navMessage.style.top = e.clientY + offsetTop + 'px'
        const title = document.createElement("p")
        title.style.color = "white"
        title.style.marginLeft = "10px"
        title.style.fontFamily = "Helvetica"
        title.style.fontSize = '14px'
        title.innerHTML = 'This button already links to "' + dest + '".<br>Do you want to overwrite ?'
        const nopeBtn = document.createElement("button")
        nopeBtn.className = 'nopeBtn'
        nopeBtn.innerHTML = 'No'
        nopeBtn.onclick = (e) =
    >
        dismissNav(navMessage)
        const yesBtn = document.createElement("button")
        yesBtn.className = 'yesBtn'
        yesBtn.innerHTML = 'Yes'
        yesBtn.onclick = (e) =
    >
        {
            dismissNav(navMessage)
            //remove from 'to' array in source page
            for (let i = 0; i < pages[target.id].to.length; i++) {
                let nav = pages[target.id].to[i]
                if (nav.button == buttonId) {
                    pages[target.id].to.splice(i)
                    break
                }
            }
            //remove from 'from' array in destination page
            for (let i = 0; i < pages[dest].from.length; i++) {
                let src = pages[dest].from[i]
                if (src == target.id) {
                    pages[dest].from.splice(i)
                    break
                }
            }
            //delete old segue
            const svg = document.getElementById("svg")
            svg.removeChild(svg.getElementById(target.id + '-' + dest))

            addNavigation(target, element)
        }

        navMessage.appendChild(title)
        navMessage.appendChild(yesBtn)
        navMessage.appendChild(nopeBtn)
        document.querySelector("body").appendChild(navMessage)

        shouldDismiss = true
    }

    function dismissNav(navMessage) {
        //remove buttons container
        document.querySelector("body").removeChild(navMessage)
        //remove temp segue
        const svg = document.getElementById("svg")
        svg.removeChild(svg.getElementById("navArrow"))
    }

    function addNavigation(target, element) {
        java.addNavigation(target.id, buttonId, element.id)
        //add arrows to dest
        const svg = document.getElementById("svg")
        if (!document.getElementById(element.id + '-enterArrow')) {
            const enterArrow = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            enterArrow.setAttribute('id', element.id + '-enterArrow');
            enterArrow.setAttribute("stroke", "black")
            enterArrow.setAttribute("class", "arrow")
            setEnterArrowPosition(enterArrow, element.id)
            svg.appendChild(enterArrow)
        }
        if (!document.getElementById(target.id + '-' + element.id)) {
            const segue = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            segue.setAttribute('id', target.id + '-' + element.id);
            segue.setAttribute("stroke", "black")
            segue.setAttribute("class", "segue")
            setSeguePosition(segue, target.id, element.id)
            svg.appendChild(segue)
        }
        //update to and from arrays
        pages[target.id].to.push({
            dest: element.id,
            button: buttonId
        })
        pages[element.id].from.push(target.id)
        buttonId = null
    }

    function startNavDrag(e) {
        buttonId = targ.id

        while (targ.parentNode) {
            targ = targ.parentNode;
            if (targ.className == 'page')
                break
        }

        nav = true

        let offsetLeft = document.body.scrollLeft
        let offsetTop = document.body.scrollTop
        startX = e.clientX + offsetLeft
        startY = e.clientY + offsetTop

        createNavArrow(startX, startY)

        drag = true;
        document.onmousemove = dragNav;
    }

    function createNavArrow(x, y) {
        const segue = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        segue.setAttribute('id', 'navArrow');
        segue.setAttribute("stroke", "black")
        segue.setAttribute("class", "segue")
        segue.setAttribute('x1', x);
        segue.setAttribute('y1', y);
        segue.setAttribute('x2', x);
        segue.setAttribute('y2', y);
        const svg = document.querySelector("#svg")
        svg.appendChild(segue)
    }

    function dragNav(e) {
        if (!drag) return

        const svg = document.querySelector("#svg")
        const segue = svg.getElementById("navArrow")
        let offsetLeft = document.body.scrollLeft
        let offsetTop = document.body.scrollTop
        segue.setAttribute('x2', e.clientX + offsetLeft);
        segue.setAttribute('y2', e.clientY + offsetTop);
    }

    function search(text) {
        document.getElementById("Page3-container").scrollIntoView()
    }

</script>
</body>
</html>