<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>storyboard</title>
    <style type="text/css">

        body {
            background-color: #585C5F;
        }

        .pageDiv {
            position: absolute;
        }

        .dragBar {
            cursor: move;
            height: 20px;
            border: 1px solid lightgray;
            background-color: lightgray;
            margin-bottom: 4px;
            border-radius: 2px;
        }

        .dragBar:hover {
            background-color: lightgray;
        }

        .pageImg {
            cursor: pointer;
            width: 200px;
            height: 398px;
            object-fit: cover;
        }

        .arrow {
            stroke: rgb(0, 0, 0);
            stroke-width: 2;
            marker-end: url(#markerArrow)
        }

        .segue {
            stroke: rgb(0, 0, 0);
            stroke-width: 2;
        }
    </style>
</head>
<body>

<svg height="5000px" width="5000px" style="position: absolute" id="svg">
    <defs>
        <marker id="markerArrow" markerWidth="15" markerHeight="15" refX="2" refY="6"
                orient="auto">
            <path d="M2,2 L2,11 L10,6 L2,2" style="fill: #000000;"/>
        </marker>
    </defs>
</svg>

<script type="text/javascript">

    window.onload = function () {
        zoom = 70;
        document.body.style.zoom = zoom + "%"
        drawStoryboard();
        document.onmousedown = startDrag;
        document.onmouseup = stopDrag;
        document.onkeydown = (e) =
    >
        {
            var evtobj = window.event ? event : e
            if ((evtobj.keyCode == 107 || evtobj.keyCode == 61) && evtobj.ctrlKey) {
                zoom = Math.min(100, zoom + 10)
                document.body.style.zoom = zoom + "%"
            }
            if ((evtobj.keyCode == 109 || evtobj.keyCode == 54) && evtobj.ctrlKey) {
                zoom = Math.max(30, zoom - 10)
                document.body.style.zoom = zoom + "%"
            }
            if ((evtobj.keyCode == 96 || evtobj.keyCode == 48) && evtobj.ctrlKey) {
                zoom = 100
                document.body.style.zoom = zoom + "%"
            }
        }
    }

    function drawStoryboard() {

        fetch('storyboard.json')
            .then(response = > response.json()
    )
    .
        then(json = > {
            pages = {}
            json.forEach(function (obj) {
                obj.to = []
                obj.from = []
                pages[obj.page] = obj

                const div = document.createElement("div")
                div.style.left = obj.x + 'px'
                div.style.top = obj.y + 'px'
                div.className = 'pageDiv'

                const dragBar = document.createElement("div")
                dragBar.className = 'dragBar'

                const img = document.createElement("img")
                img.setAttribute("src", "./pages/" + obj.page + "/snapshot.png")
                img.setAttribute("id", obj.page)
                img.className = 'pageImg'

                div.appendChild(dragBar)
                div.appendChild(img)
                document.querySelector("body").appendChild(div)
            });
        drawArrows()
    })
    }

    async

    function drawArrows() {
        for (const key in pages) {
            if (pages.hasOwnProperty(key)) {
                const page = pages[key];
                const svg = document.getElementById("svg")

                await
                fetch('pages/' + key + '/conf.json')
                    .then(response = > response.json()
            )
            .
                then(json = > {
                    json.actions.forEach(action = > {
                        if(action.type !== 'nav'
            )
                return

                page.to.push(action.dest)
                pages[action.dest].from.push(key)
                const segue = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                segue.setAttribute('id', key + '-' + action.dest);
                segue.setAttribute("stroke", "black")
                segue.setAttribute("class", "segue")
                setSeguePosition(segue, page.page, action.dest)
                svg.appendChild(segue)
            })
                ;
            })
            }
        }

        for (const key in pages) {
            if (pages.hasOwnProperty(key)) {
                const page = pages[key];
                if (page.from.length == 0) continue

                const enterArrow = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                enterArrow.setAttribute('id', key + '-enterArrow');
                enterArrow.setAttribute("stroke", "black")
                enterArrow.setAttribute("class", "arrow")
                setEnterArrowPosition(enterArrow, key)
                svg.appendChild(enterArrow)
            }
        }
    }

    function setSeguePosition(segue, src, dest) {
        var srcImg = document.getElementById(src)
        var destImg = document.getElementById(dest)

        var left1 = parseInt(srcImg.parentElement.style.left.slice(0, srcImg.parentElement.style.left.length - 2))
        var top1 = parseInt(srcImg.parentElement.style.top.slice(0, srcImg.parentElement.style.top.length - 2))
        var left2 = parseInt(destImg.parentElement.style.left.slice(0, destImg.parentElement.style.left.length - 2))
        var top2 = parseInt(destImg.parentElement.style.top.slice(0, destImg.parentElement.style.top.length - 2))

        segue.setAttribute('x1', left1 + 191);
        segue.setAttribute('y1', top1 + 20 + 4 + srcImg.clientHeight / 2);
        segue.setAttribute('x2', left2 - 60);
        segue.setAttribute('y2', top2 + 20 + 4 + destImg.clientHeight / 2);
    }

    function setEnterArrowPosition(arrow, pageId) {
        var pageImg = document.getElementById(pageId)

        var left = parseInt(pageImg.parentElement.style.left.slice(0, pageImg.parentElement.style.left.length - 2))
        var top = parseInt(pageImg.parentElement.style.top.slice(0, pageImg.parentElement.style.top.length - 2))

        arrow.setAttribute('x1', left - 60);
        arrow.setAttribute('y1', top + 20 + 4 + pageImg.clientHeight / 2);
        arrow.setAttribute('x2', left - 25);
        arrow.setAttribute('y2', top + 20 + 4 + pageImg.clientHeight / 2);
    }

    function startDrag(e) {
        // determine event object
        if (!e) {
            var e = window.event;
        }
        if (e.preventDefault) e.preventDefault();
        // IE uses srcElement, others use target
        targ = e.target ? e.target : e.srcElement;

        if (targ.className != 'dragBar') {
            return
        }
        ;
        console.log('start drag')
        // calculate event X, Y coordinates
        offsetX = e.clientX;
        offsetY = e.clientY;

        // assign default values for topp and left properties
        if (!targ.parentElement.style.left) {
            targ.parentElement.style.left = '0px'
        }
        ;
        if (!targ.parentElement.style.top) {
            targ.parentElement.style.top = '0px'
        }
        ;

        // calculate integer values for top and left
        // properties
        coordX = parseInt(targ.parentElement.style.left);
        coordY = parseInt(targ.parentElement.style.top);
        drag = true;

        // move div element
        document.onmousemove = dragDiv;
        return false;

    }

    function dragDiv(e) {
        if (!drag) {
            return
        }
        ;
        if (!e) {
            var e = window.event
        }
        ;

        targ.parentElement.style.left = coordX + e.clientX - offsetX + 'px';
        targ.parentElement.style.top = coordY + e.clientY - offsetY + 'px';

        targ = targ.parentElement.children[1]

        const enterArrow = document.getElementById(targ.id + "-enterArrow")
        if (enterArrow) setEnterArrowPosition(enterArrow, targ.id)

        let to = pages[targ.id].to
        to.forEach(dest = > {
            const segue = document.getElementById(targ.id + "-" + dest)
            setSeguePosition(segue, targ.id, dest
    )
    })
        ;

        let from = pages[targ.id].from
        from.forEach(src = > {
            const segue = document.getElementById(src + "-" + targ.id)
            setSeguePosition(segue, src, targ.id
    )
    })
        ;

        return false;
    }

    function stopDrag() {
        drag = false;
    }

</script>
</body>
</html>